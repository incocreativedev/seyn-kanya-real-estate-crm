<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyson Properties Real Estate CRM</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#1a5f5f">
    <meta name="msapplication-TileColor" content="#1a5f5f">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Tyson Properties">
    
    <!-- Favicons and App Icons -->
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/images/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/images/icon-512.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="/images/icon-144.png">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Description for SEO and PWA -->
    <meta name="description" content="Premium real estate CRM by Tyson Properties for managing clients, leads, properties, and reminders. Works offline with cloud sync.">
    <meta name="keywords" content="real estate, CRM, property management, lead tracking, offline app, Tyson Properties">
    
    <!-- Open Graph meta tags -->
    <meta property="og:title" content="Tyson Properties Real Estate CRM">
    <meta property="og:description" content="Premium real estate CRM for managing clients, leads, properties, and reminders">
    <meta property="og:image" content="/images/icon-512.png">
    <meta property="og:type" content="website">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        .header {
            background: #ffffff;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(26, 95, 95, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid #1a5f5f;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            width: 120px;
            height: 80px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon {
            width: 60px;
            height: 40px;
            background: linear-gradient(135deg, #b8b8b8 0%, #d4d4d4 50%, #a0a0a0 100%);
            clip-path: polygon(50% 0%, 0% 100%, 20% 100%, 35% 20%, 65% 20%, 80% 100%, 100% 100%);
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(26, 95, 95, 0.2);
        }
        
        .logo-text {
            font-family: 'Arial Black', Arial, sans-serif;
            font-weight: 900;
            font-size: 12px;
            color: #1a5f5f;
            letter-spacing: 0.5px;
            text-align: center;
            line-height: 1.1;
        }
        
        .team-profiles {
            display: flex;
            gap: 15px;
        }
        
        .profile {
            text-align: center;
        }
        
        .profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .profile-name {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .tab-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(26, 95, 95, 0.1);
            overflow: hidden;
            border: 1px solid rgba(26, 95, 95, 0.08);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .tab-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(26, 95, 95, 0.15);
        }
        
        .tabs {
            display: flex;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-bottom: 1px solid rgba(26, 95, 95, 0.1);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 18px 28px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(45deg, #1a5f5f, #2d7d7d);
            border-radius: 2px 2px 0 0;
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }
        
        .tab.active {
            background: white;
            color: #1a5f5f;
            font-weight: 600;
            transform: translateY(-1px);
        }
        
        .tab.active::before {
            width: 80%;
        }
        
        .tab:hover {
            background: rgba(26, 95, 95, 0.05);
            color: #1a5f5f;
            transform: translateY(-1px);
        }
        
        .tab:hover::before {
            width: 60%;
        }
        
        .tab-content {
            display: none;
            padding: 32px;
            animation: slideIn 0.4s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(26, 95, 95, 0.08);
            box-shadow: 0 4px 16px rgba(26, 95, 95, 0.05);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 140px;
            flex: 1;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #495057;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .filter-group input, .filter-group select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            font-family: inherit;
        }
        
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #1a5f5f;
            box-shadow: 0 0 0 3px rgba(26, 95, 95, 0.1), 0 4px 16px rgba(26, 95, 95, 0.1);
            transform: translateY(-1px);
        }
        
        .filter-group input:hover, .filter-group select:hover {
            border-color: #ced4da;
            transform: translateY(-1px);
        }
        
        .search-bar {
            position: relative;
            flex: 2;
            min-width: 300px;
        }
        
        .search-bar input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .search-bar::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            z-index: 1;
        }
        
        .quick-actions {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a5f5f 0%, #2d7d7d 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(26, 95, 95, 0.3);
            background: linear-gradient(135deg, #0d4444 0%, #1a5f5f 100%);
        }
        
        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(26, 95, 95, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffed4e 100%);
            color: #212529;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
            background: linear-gradient(135deg, #e0a800 0%, #ffc107 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
            background: linear-gradient(135deg, #117a8b 0%, #17a2b8 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
            background: linear-gradient(135deg, #bd2130 0%, #dc3545 100%);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 8px;
        }
        
        .btn-ghost {
            background: transparent;
            color: #1a5f5f;
            border: 2px solid #1a5f5f;
            box-shadow: none;
        }
        
        .btn-ghost:hover {
            background: #1a5f5f;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 95, 95, 0.2);
        }
        
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(26, 95, 95, 0.1);
            border: 1px solid rgba(26, 95, 95, 0.08);
            margin-bottom: 24px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 16px 20px;
            text-align: left;
            font-weight: 700;
            color: #1a5f5f;
            border-bottom: 2px solid rgba(26, 95, 95, 0.1);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }
        
        .data-table th:first-child {
            border-top-left-radius: 16px;
        }
        
        .data-table th:last-child {
            border-top-right-radius: 16px;
        }
        
        .data-table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #1a5f5f, #2d7d7d);
        }
        
        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(26, 95, 95, 0.06);
            font-size: 14px;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .data-table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .data-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(26, 95, 95, 0.02) 0%, rgba(26, 95, 95, 0.05) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(26, 95, 95, 0.08);
        }
        
        .data-table tbody tr:hover td {
            color: #1a5f5f;
        }
        
        .data-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 16px;
        }
        
        .data-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 16px;
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .table-container {
            background: white;
            border-radius: 20px;
            padding: 8px;
            box-shadow: 0 8px 32px rgba(26, 95, 95, 0.1);
            border: 1px solid rgba(26, 95, 95, 0.08);
            margin-bottom: 32px;
        }
        
        .clickable-name {
            color: #1a5f5f;
            cursor: pointer;
            font-weight: 500;
            text-decoration: underline;
        }
        
        .clickable-name:hover {
            color: #2d7d7d;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1a5f5f;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .property-card {
            background: white;
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(26, 95, 95, 0.08);
            border: 1px solid rgba(26, 95, 95, 0.08);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .property-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #1a5f5f 0%, #2d7d7d 100%);
        }
        
        .property-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(26, 95, 95, 0.15);
            border-color: rgba(26, 95, 95, 0.15);
        }
        
        .property-card:hover::before {
            width: 6px;
            box-shadow: 0 0 20px rgba(26, 95, 95, 0.3);
        }
        
        .property-card h3 {
            color: #1a5f5f;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }
        
        .property-card .property-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        
        .property-card .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .property-card .meta-item .icon {
            font-size: 16px;
            color: #1a5f5f;
        }
        
        .client-detail-card {
            background: linear-gradient(135deg, #1a5f5f 0%, #2d7d7d 100%);
            color: white;
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 28px;
            box-shadow: 0 16px 48px rgba(26, 95, 95, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .client-detail-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            transform: rotate(45deg);
        }
        
        .client-detail-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 60px rgba(26, 95, 95, 0.25);
        }
        
        .client-detail-card h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        .client-detail-card .client-type {
            display: inline-block;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .client-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .detail-item {
            background: rgba(255, 255, 255, 0.12);
            padding: 20px;
            border-radius: 16px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .detail-item:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateY(-2px);
        }
        
        .detail-item strong {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .detail-item span {
            font-size: 16px;
            font-weight: 500;
        }
        
        .property-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-sold {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-buyer {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-seller {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-tenant {
            background: #d4edda;
            color: #155724;
        }
        
        .reminder-badge {
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .birthday-badge {
            background: #ff9f43;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            margin-bottom: 15px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .url-input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .contact-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .price-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .price-range input {
            flex: 1;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #1a5f5f 0%, #2d7d7d 100%);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(26, 95, 95, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .fab:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 12px 40px rgba(26, 95, 95, 0.4);
        }
        
        .fab:active {
            transform: translateY(-2px) scale(1.05);
        }
        
        /* Quick Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(26, 95, 95, 0.08);
            border: 1px solid rgba(26, 95, 95, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1a5f5f, #2d7d7d);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(26, 95, 95, 0.12);
        }
        
        .stat-card .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #1a5f5f 0%, #2d7d7d 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-bottom: 16px;
        }
        
        .stat-card .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #1a5f5f;
            margin-bottom: 8px;
        }
        
        .stat-card .stat-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Loading States */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            font-size: 16px;
            color: #6c757d;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #1a5f5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #495057;
        }
        
        .empty-state p {
            font-size: 16px;
            margin-bottom: 28px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .client-detail-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 16px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .search-bar {
                min-width: 100%;
            }
            
            .property-card, .client-detail-card {
                margin-left: -8px;
                margin-right: -8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <div class="logo">
                <div class="logo-icon"></div>
                <div class="logo-text">TYSON<br>PROPERTIES</div>
            </div>
            <h1 style="color: #1a5f5f; font-size: 24px; font-weight: 600;">Real Estate CRM</h1>
        </div>
        <div class="team-profiles">
            <div class="profile" id="userProfile" style="display: none;">
                <div class="profile-pic" id="userInitials"></div>
                <div class="profile-name" id="userName"></div>
            </div>
            <div style="margin-left: 20px; display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-info btn-small" onclick="exportData()">üìä Export Data</button>
                <div class="dropdown" style="position: relative;">
                    <button class="btn btn-success btn-small" onclick="toggleUserMenu()" id="userMenuButton">
                        üë§ <span id="userMenuName">User</span> ‚ñº
                    </button>
                    <div id="userDropdown" class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 200px; z-index: 1000;">
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; margin-bottom: 5px;" id="dropdownUserName"></div>
                            <div style="font-size: 12px; color: #666;" id="dropdownUserEmail"></div>
                            <div style="font-size: 12px; color: #666;" id="dropdownUserCompany"></div>
                        </div>
                        <div style="padding: 10px;">
                            <button class="btn btn-warning btn-small" onclick="editProfile()" style="width: 100%; margin-bottom: 5px;">‚úèÔ∏è Edit Profile</button>
                            <button class="btn btn-danger btn-small" onclick="logout()" style="width: 100%;">üö™ Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('contacts')">üë• All Clients</button>
                <button class="tab" onclick="showTab('leads')">üéØ Potential Leads</button>
                <button class="tab" onclick="showTab('properties')">üè† Properties</button>
                <button class="tab" onclick="showTab('reminders')">‚è∞ Reminders</button>
                <button class="tab" onclick="showTab('comments')">üìù Comments</button>
                <button class="tab" onclick="showTab('import')">üì• Import Listings</button>
                <button class="tab" onclick="showTab('chat')">ü§ñ AI Assistant</button>
            </div>

            <!-- All Clients Tab -->
            <div id="contacts" class="tab-content active">
                <h2>Client Management</h2>
                
                <!-- Quick Stats -->
                <div class="stats-grid" id="clientStats">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üè†</div>
                        <div class="stat-number" id="buyerClients">0</div>
                        <div class="stat-label">Buyers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-number" id="sellerClients">0</div>
                        <div class="stat-label">Sellers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üè°</div>
                        <div class="stat-number" id="tenantClients">0</div>
                        <div class="stat-label">Tenants</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showModal('addClientModal')">‚ûï Add New Client</button>
                </div>

                <div class="filters">
                    <div class="search-bar">
                        <label>üîç Search Clients</label>
                        <input type="text" id="nameFilter" placeholder="Search by name, email, phone, or notes..." onkeyup="filterClients()" autocomplete="off">
                    </div>
                    <div class="filter-group">
                        <label>Client Type</label>
                        <select id="typeFilter" onchange="filterClients()">
                            <option value="">All Types</option>
                            <option value="buyer">üè† Buyer</option>
                            <option value="seller">üí∞ Seller</option>
                            <option value="tenant">üè° Tenant</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Budget Range (ZAR)</label>
                        <div class="price-range">
                            <input type="number" id="minPrice" placeholder="R 50,000" min="5000" max="25000000" onchange="filterClients()">
                            <span style="color: #6c757d; font-weight: 500;">to</span>
                            <input type="number" id="maxPrice" placeholder="R 25,000,000" min="5000" max="25000000" onchange="filterClients()">
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-ghost btn-small" onclick="clearFilters('clients')">üóëÔ∏è Clear</button>
                        <button class="btn btn-primary btn-small" onclick="exportFilteredClients()">üì§ Export</button>
                    </div>
                </div>

                <!-- Client Details Display -->
                <div id="clientDetailsDisplay" style="display: none;">
                    <!-- Client details will be displayed here -->
                </div>

                <table class="data-table" id="clientsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Budget Range</th>
                            <th>Birthday</th>
                            <th>Next Reminder</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Potential Leads Tab -->
            <div id="leads" class="tab-content">
                <h2>Potential Leads</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showModal('addLeadModal')">‚ûï Add New Lead</button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Search Lead:</label>
                        <input type="text" id="leadNameFilter" placeholder="Enter name..." onkeyup="filterLeads()">
                    </div>
                    <div class="filter-group">
                        <label>Follow-up Date:</label>
                        <input type="date" id="leadDateFilter" onchange="filterLeads()">
                    </div>
                </div>

                <table class="data-table" id="leadsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Interest</th>
                            <th>Follow-up Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Properties Tab -->
            <div id="properties" class="tab-content">
                <h2>Property Listings</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showModal('addPropertyModal')">‚ûï Add New Property</button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Search Properties:</label>
                        <input type="text" id="propertySearch" placeholder="Search title, location, description..." onkeyup="filterProperties()">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="statusFilter" onchange="filterProperties()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="sold">Sold/Rented</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Type:</label>
                        <select id="propertyTypeFilter" onchange="filterProperties()">
                            <option value="">All Types</option>
                            <option value="sale">For Sale</option>
                            <option value="rent">For Rent</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Price Range (ZAR):</label>
                        <div class="price-range">
                            <input type="number" id="propMinPrice" placeholder="R 5,000" min="5000" max="25000000" onchange="filterProperties()">
                            <span>to</span>
                            <input type="number" id="propMaxPrice" placeholder="R 25,000,000" min="5000" max="25000000" onchange="filterProperties()">
                        </div>
                    </div>
                </div>

                <div id="propertiesList">
                    <!-- Properties will be populated by JavaScript -->
                </div>
            </div>

            <!-- Reminders Tab -->
            <div id="reminders" class="tab-content">
                <h2>Reminders & Follow-ups</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showModal('addReminderModal')">‚ûï Add New Reminder</button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Filter by Date:</label>
                        <input type="date" id="reminderDateFilter" onchange="filterReminders()">
                    </div>
                    <div class="filter-group">
                        <label>Reminder Type:</label>
                        <select id="reminderTypeFilter" onchange="filterReminders()">
                            <option value="">All Types</option>
                            <option value="call">Call Client</option>
                            <option value="birthday">Birthday</option>
                            <option value="follow-up">Follow-up</option>
                            <option value="meeting">Meeting</option>
                        </select>
                    </div>
                </div>

                <div id="remindersList">
                    <!-- Reminders will be populated by JavaScript -->
                </div>
            </div>

            <!-- Comments Tab -->
            <div id="comments" class="tab-content">
                <h2>Notes & Comments</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showModal('addCommentModal')">‚ûï Add New Note</button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Category:</label>
                        <select id="commentCategoryFilter" onchange="filterComments()">
                            <option value="">All Categories</option>
                            <option value="client">Client Notes</option>
                            <option value="property">Property Notes</option>
                            <option value="meeting">Meeting Notes</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                </div>

                <div id="commentsList">
                    <!-- Comments will be populated by JavaScript -->
                </div>
            </div>

            <!-- Import Listings Tab -->
            <div id="import" class="tab-content">
                <h2>Import Property Listings</h2>
                
                <div class="url-input-section">
                    <h3>Import from Property24 or Other Websites</h3>
                    <p>Paste the URL of a property listing to automatically import all details:</p>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="url" id="listingUrl" placeholder="https://property24.com/listing..." style="flex: 1; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                        <button class="btn btn-primary" onclick="importListing()">üì• Import Listing</button>
                    </div>
                </div>

                <div id="importResult" style="display: none;">
                    <h3>Imported Property Details</h3>
                    <div class="property-card">
                        <div id="importedDetails">
                            <!-- Imported details will appear here -->
                        </div>
                        <button class="btn btn-success" onclick="saveImportedProperty()">üíæ Save Property</button>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <h2>AI Assistant for Messages & Emails</h2>
                <p>Use this AI assistant to help craft professional messages and emails for your clients.</p>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>AI Assistant:</strong> Hi! I'm here to help you create professional messages and emails for your real estate business. What would you like help with today?
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Ask me to help with messages, emails, or any real estate communication..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addClientModal')">&times;</span>
            <h2>Add New Client</h2>
            <form onsubmit="addClient(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name:</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Number:</label>
                        <input type="tel" name="phone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email Address:</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Client Type:</label>
                        <select name="type" required>
                            <option value="">Select Type</option>
                            <option value="buyer">Buyer</option>
                            <option value="seller">Seller</option>
                            <option value="tenant">Tenant</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birthday:</label>
                        <input type="date" name="birthday">
                    </div>
                    <div class="form-group">
                        <label>Next Reminder Date:</label>
                        <input type="date" name="reminderDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Budget Min (ZAR):</label>
                        <input type="number" name="budgetMin" min="5000" max="25000000" placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label>Budget Max (ZAR):</label>
                        <input type="number" name="budgetMax" min="5000" max="25000000" placeholder="25000000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Additional Notes:</label>
                    <textarea name="notes" rows="3" placeholder="Any additional information about the client..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Client</button>
            </form>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addLeadModal')">&times;</span>
            <h2>Add New Lead</h2>
            <form onsubmit="addLead(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name:</label>
                        <input type="text" name="leadName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Number:</label>
                        <input type="tel" name="leadPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email (Optional):</label>
                        <input type="email" name="leadEmail">
                    </div>
                    <div class="form-group">
                        <label>Interest:</label>
                        <select name="leadInterest" required>
                            <option value="">Select Interest</option>
                            <option value="buying">Looking to Buy</option>
                            <option value="selling">Looking to Sell</option>
                            <option value="renting">Looking to Rent</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Follow-up Date:</label>
                        <input type="date" name="followUpDate" required>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select name="leadStatus" required>
                            <option value="new">New Lead</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="converted">Converted</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea name="leadNotes" rows="3" placeholder="Lead source, preferences, etc..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Lead</button>
            </form>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addPropertyModal')">&times;</span>
            <h2>Add New Property</h2>
            <form onsubmit="addProperty(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Property Title:</label>
                        <input type="text" name="title" required>
                    </div>
                    <div class="form-group">
                        <label>Price (ZAR):</label>
                        <input type="number" name="price" min="5000" max="25000000" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type:</label>
                        <select name="propertyType" required>
                            <option value="">Select Type</option>
                            <option value="sale">For Sale</option>
                            <option value="rent">For Rent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select name="status" required>
                            <option value="">Select Status</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="sold">Sold/Rented</option>
                        </select>
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Bedrooms:</label>
                        <input type="number" name="bedrooms" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label>Bathrooms:</label>
                        <input type="number" name="bathrooms" min="0" max="20" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Size (sqm):</label>
                        <input type="number" name="size" min="1" max="10000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" name="location" placeholder="Area, City, Province" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea name="description" rows="4" placeholder="Property description, features, etc..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Property</button>
            </form>
        </div>
    </div>

    <!-- Add Reminder Modal -->
    <div id="addReminderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addReminderModal')">&times;</span>
            <h2>Add New Reminder</h2>
            <form onsubmit="addReminder(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Title:</label>
                        <input type="text" name="reminderTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" name="reminderDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Time:</label>
                        <input type="time" name="reminderTime">
                    </div>
                    <div class="form-group">
                        <label>Type:</label>
                        <select name="reminderType" required>
                            <option value="">Select Type</option>
                            <option value="call">Call Client</option>
                            <option value="birthday">Birthday</option>
                            <option value="follow-up">Follow-up</option>
                            <option value="meeting">Meeting</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Related Client (Optional):</label>
                    <select name="relatedClient">
                        <option value="">Select Client</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea name="reminderNotes" rows="3" placeholder="Additional details about this reminder..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Reminder</button>
            </form>
        </div>
    </div>

    <!-- Add Comment Modal -->
    <div id="addCommentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCommentModal')">&times;</span>
            <h2>Add New Note</h2>
            <form onsubmit="addComment(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Title:</label>
                        <input type="text" name="commentTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Category:</label>
                        <select name="commentCategory" required>
                            <option value="">Select Category</option>
                            <option value="client">Client Notes</option>
                            <option value="property">Property Notes</option>
                            <option value="meeting">Meeting Notes</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Related To (Optional):</label>
                    <input type="text" name="relatedTo" placeholder="Client name, property address, etc.">
                </div>
                <div class="form-group">
                    <label>Content:</label>
                    <textarea name="commentContent" rows="5" placeholder="Write your note here..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Note</button>
            </form>
        </div>
    </div>

    <!-- Edit Property Modal -->
    <div id="editPropertyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editPropertyModal')">&times;</span>
            <h2>Edit Property</h2>
            <form onsubmit="updateProperty(event)">
                <input type="hidden" name="propertyId" id="editPropertyId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Property Title:</label>
                        <input type="text" name="title" id="editPropertyTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Price (ZAR):</label>
                        <input type="number" name="price" id="editPropertyPrice" min="5000" max="25000000" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type:</label>
                        <select name="propertyType" id="editPropertyType" required>
                            <option value="">Select Type</option>
                            <option value="sale">For Sale</option>
                            <option value="rent">For Rent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select name="status" id="editPropertyStatus" required>
                            <option value="">Select Status</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="sold">Sold/Rented</option>
                        </select>
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Bedrooms:</label>
                        <input type="number" name="bedrooms" id="editPropertyBedrooms" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label>Bathrooms:</label>
                        <input type="number" name="bathrooms" id="editPropertyBathrooms" min="0" max="20" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Size (sqm):</label>
                        <input type="number" name="size" id="editPropertySize" min="1" max="10000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" name="location" id="editPropertyLocation" placeholder="Area, City, Province" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea name="description" id="editPropertyDescription" rows="4" placeholder="Property description, features, etc..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Property</button>
            </form>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div id="editClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editClientModal')">&times;</span>
            <h2>Edit Client</h2>
            <form onsubmit="updateClient(event)">
                <input type="hidden" name="clientId" id="editClientId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name:</label>
                        <input type="text" name="name" id="editClientName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Number:</label>
                        <input type="tel" name="phone" id="editClientPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email Address:</label>
                        <input type="email" name="email" id="editClientEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Client Type:</label>
                        <select name="type" id="editClientType" required>
                            <option value="">Select Type</option>
                            <option value="buyer">Buyer</option>
                            <option value="seller">Seller</option>
                            <option value="tenant">Tenant</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birthday:</label>
                        <input type="date" name="birthday" id="editClientBirthday">
                    </div>
                    <div class="form-group">
                        <label>Next Reminder Date:</label>
                        <input type="date" name="reminderDate" id="editClientReminderDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Budget Min (ZAR):</label>
                        <input type="number" name="budgetMin" id="editClientBudgetMin" min="5000" max="25000000" placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label>Budget Max (ZAR):</label>
                        <input type="number" name="budgetMax" id="editClientBudgetMax" min="5000" max="25000000" placeholder="25000000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Additional Notes:</label>
                    <textarea name="notes" id="editClientNotes" rows="3" placeholder="Any additional information about the client..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Client</button>
            </form>
        </div>
    </div>

    <!-- Edit Lead Modal -->
    <div id="editLeadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editLeadModal')">&times;</span>
            <h2>Edit Lead</h2>
            <form onsubmit="updateLead(event)">
                <input type="hidden" name="leadId" id="editLeadId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name:</label>
                        <input type="text" name="leadName" id="editLeadName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Number:</label>
                        <input type="tel" name="leadPhone" id="editLeadPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email (Optional):</label>
                        <input type="email" name="leadEmail" id="editLeadEmail">
                    </div>
                    <div class="form-group">
                        <label>Interest:</label>
                        <select name="leadInterest" id="editLeadInterest" required>
                            <option value="">Select Interest</option>
                            <option value="buying">Looking to Buy</option>
                            <option value="selling">Looking to Sell</option>
                            <option value="renting">Looking to Rent</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Follow-up Date:</label>
                        <input type="date" name="followUpDate" id="editLeadFollowUpDate" required>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select name="leadStatus" id="editLeadStatus" required>
                            <option value="new">New Lead</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="converted">Converted</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea name="leadNotes" id="editLeadNotes" rows="3" placeholder="Lead source, preferences, etc..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Lead</button>
            </form>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showQuickAdd()" title="Quick Add">
        ‚ûï
    </button>

    <!-- Quick Add Menu (hidden by default) -->
    <div id="quickAddMenu" style="position: fixed; bottom: 100px; right: 32px; z-index: 999; display: none;">
        <div style="background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(26, 95, 95, 0.2); padding: 16px; min-width: 200px;">
            <div style="margin-bottom: 12px; font-weight: 600; color: #1a5f5f; font-size: 14px;">Quick Add</div>
            <button class="btn btn-primary btn-small" onclick="quickAddClient()" style="width: 100%; margin-bottom: 8px;">üë§ Add Client</button>
            <button class="btn btn-primary btn-small" onclick="quickAddLead()" style="width: 100%; margin-bottom: 8px;">üéØ Add Lead</button>
            <button class="btn btn-primary btn-small" onclick="quickAddProperty()" style="width: 100%; margin-bottom: 8px;">üè† Add Property</button>
            <button class="btn btn-primary btn-small" onclick="quickAddReminder()" style="width: 100%;">‚è∞ Add Reminder</button>
        </div>
    </div>

    <script>
        // Data storage
        let clients = [];
        let leads = [];
        let properties = [];
        let reminders = [];
        let comments = [];

        // Authentication state
        let currentUser = null;
        let authToken = null;

        // API Configuration
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8888/.netlify/functions' 
            : '/.netlify/functions';

        // Authentication Functions
        function checkAuthentication() {
            authToken = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('currentUser');
            
            if (authToken && userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                    updateUserInterface();
                    return true;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    clearAuthData();
                }
            }
            
            // Redirect to auth page if not authenticated
            window.location.href = '/auth.html';
            return false;
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Update user menu
            const userMenuName = document.getElementById('userMenuName');
            const dropdownUserName = document.getElementById('dropdownUserName');
            const dropdownUserEmail = document.getElementById('dropdownUserEmail');
            const dropdownUserCompany = document.getElementById('dropdownUserCompany');
            
            const firstName = currentUser.fullName.split(' ')[0];
            userMenuName.textContent = firstName;
            dropdownUserName.textContent = currentUser.fullName;
            dropdownUserEmail.textContent = currentUser.email;
            dropdownUserCompany.textContent = currentUser.company || 'No company';
            
            // Show user profile
            const userProfile = document.getElementById('userProfile');
            const userInitials = document.getElementById('userInitials');
            const userName = document.getElementById('userName');
            
            const initials = currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            userInitials.textContent = initials;
            userName.textContent = firstName;
            userProfile.style.display = 'block';
        }
        
        function clearAuthData() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
        }
        
        function logout() {
            const confirmed = confirm('Are you sure you want to logout?');
            if (confirmed) {
                clearAuthData();
                window.location.href = '/auth.html';
            }
        }
        
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function editProfile() {
            alert('Profile editing functionality will be implemented soon.');
            toggleUserMenu();
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const menuButton = document.getElementById('userMenuButton');
            
            if (!menuButton.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // API Helper Functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}/${endpoint}`;
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            // Add auth token if available
            if (authToken) {
                defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
            }

            const config = { ...defaultOptions, ...options };

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    // Handle authentication errors
                    if (response.status === 401) {
                        clearAuthData();
                        window.location.href = '/auth.html';
                        return;
                    }
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                
                // Show user-friendly error message
                alert(`Network error: ${error.message}. Please check your connection and try again.`);
                throw error;
            }
        }

        // Data Loading Functions
        async function loadClients() {
            try {
                const data = await apiRequest('clients');
                clients = data.clients || [];
            renderClients();
                populateClientOptions();
            } catch (error) {
                console.error('Failed to load clients:', error);
                // Fall back to localStorage if API fails
                loadClientsFromStorage();
            }
        }

        async function loadLeads() {
            try {
                const data = await apiRequest('leads');
                leads = data.leads || [];
            renderLeads();
            } catch (error) {
                console.error('Failed to load leads:', error);
                loadLeadsFromStorage();
            }
        }

        async function loadProperties() {
            try {
                const data = await apiRequest('properties');
                properties = data.properties || [];
            renderProperties();
            } catch (error) {
                console.error('Failed to load properties:', error);
                loadPropertiesFromStorage();
            }
        }

        async function loadReminders() {
            try {
                const data = await apiRequest('reminders');
                reminders = data.reminders || [];
            renderReminders();
            } catch (error) {
                console.error('Failed to load reminders:', error);
                loadRemindersFromStorage();
            }
        }

        async function loadComments() {
            try {
                const data = await apiRequest('comments');
                comments = data.comments || [];
            renderComments();
            } catch (error) {
                console.error('Failed to load comments:', error);
                loadCommentsFromStorage();
            }
        }

        // Fallback localStorage functions (for offline mode)
        function loadClientsFromStorage() {
            const saved = localStorage.getItem('crmClients');
            if (saved) {
                clients = JSON.parse(saved);
            renderClients();
            populateClientOptions();
            }
        }

        function loadLeadsFromStorage() {
            const saved = localStorage.getItem('crmLeads');
            if (saved) {
                leads = JSON.parse(saved);
            renderLeads();
            }
        }

        function loadPropertiesFromStorage() {
            const saved = localStorage.getItem('crmProperties');
            if (saved) {
                properties = JSON.parse(saved);
            renderProperties();
            }
        }

        function loadRemindersFromStorage() {
            const saved = localStorage.getItem('crmReminders');
            if (saved) {
                reminders = JSON.parse(saved);
            renderReminders();
            }
        }

        function loadCommentsFromStorage() {
            const saved = localStorage.getItem('crmComments');
            if (saved) {
                comments = JSON.parse(saved);
            renderComments();
            }
        }

        // Keep localStorage as backup
        function saveDataToStorage() {
            localStorage.setItem('crmClients', JSON.stringify(clients));
            localStorage.setItem('crmLeads', JSON.stringify(leads));
            localStorage.setItem('crmProperties', JSON.stringify(properties));
            localStorage.setItem('crmReminders', JSON.stringify(reminders));
            localStorage.setItem('crmComments', JSON.stringify(comments));
        }

        // Initialize application
        async function initializeData() {
            console.log('Initializing CRM data...');
            
            // Show loading indicator
            showLoadingIndicator();
            
            try {
                // Load all data from API
                await Promise.all([
                    loadClients(),
                    loadLeads(),
                    loadProperties(),
                    loadReminders(),
                    loadComments()
                ]);
                
                console.log('Data loaded successfully from API');
                
                // Check if migration is needed
                if (hasLocalStorageData() && !localStorage.getItem('migrated')) {
                    showMigrationPrompt();
                }
                
            } catch (error) {
                console.error('Failed to load data from API, falling back to localStorage:', error);
                
                // Fallback to localStorage
                loadAllFromStorage();
            }
            
            hideLoadingIndicator();
        }

        function loadAllFromStorage() {
            loadClientsFromStorage();
            loadLeadsFromStorage();
            loadPropertiesFromStorage();
            loadRemindersFromStorage();
            loadCommentsFromStorage();
        }

        function hasLocalStorageData() {
            return localStorage.getItem('crmClients') || 
                   localStorage.getItem('crmLeads') || 
                   localStorage.getItem('crmProperties') || 
                   localStorage.getItem('crmReminders') || 
                   localStorage.getItem('crmComments');
        }

        function showLoadingIndicator() {
            // Add loading indicator to the page
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            loadingDiv.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="margin-bottom: 15px;">üîÑ Loading CRM Data...</div>
                    <div style="font-size: 12px; color: #666;">Connecting to database...</div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoadingIndicator() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showMigrationPrompt() {
            const migrate = confirm(
                'We found data in your browser storage. Would you like to migrate it to the cloud database?\n\n' +
                'This will ensure your data is backed up and accessible from anywhere.'
            );
            
            if (migrate) {
                migrateLocalStorageData();
            } else {
                localStorage.setItem('migrated', 'declined');
            }
        }

        async function migrateLocalStorageData() {
            try {
                showLoadingIndicator();
                
                const localData = {
                    clients: JSON.parse(localStorage.getItem('crmClients') || '[]'),
                    leads: JSON.parse(localStorage.getItem('crmLeads') || '[]'),
                    properties: JSON.parse(localStorage.getItem('crmProperties') || '[]'),
                    reminders: JSON.parse(localStorage.getItem('crmReminders') || '[]'),
                    comments: JSON.parse(localStorage.getItem('crmComments') || '[]')
                };

                const result = await apiRequest('migrate', {
                    method: 'POST',
                    body: JSON.stringify(localData)
                });

                hideLoadingIndicator();
                
                if (result.results) {
                    alert(`Migration completed!\n\n` +
                          `Clients: ${result.results.clients}\n` +
                          `Leads: ${result.results.leads}\n` +
                          `Properties: ${result.results.properties}\n` +
                          `Reminders: ${result.results.reminders}\n` +
                          `Comments: ${result.results.comments}\n\n` +
                          (result.results.errors.length > 0 ? `Errors: ${result.results.errors.length}` : 'No errors!'));
                }
                
                localStorage.setItem('migrated', 'completed');
                
                // Reload data from API
                await initializeData();
                
            } catch (error) {
                hideLoadingIndicator();
                alert('Migration failed: ' + error.message);
            }
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Hide all tab buttons
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Activate tab button
            event.target.classList.add('active');
        }

        // Modal functionality
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Format currency
        function formatCurrency(amount) {
            if (!amount) return 'Not specified';
            return new Intl.NumberFormat('en-ZA', {
                style: 'currency',
                currency: 'ZAR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA');
        }

        // Client functions
        async function addClient(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Basic validation
            const name = formData.get('name').trim();
            const phone = formData.get('phone').trim();
            const email = formData.get('email').trim();
            const budgetMin = parseInt(formData.get('budgetMin')) || 0;
            const budgetMax = parseInt(formData.get('budgetMax')) || 0;
            
            // Validate required fields
            if (!name || !phone || !email) {
                alert('Please fill in all required fields (Name, Phone, Email)');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Validate phone format (basic South African format)
            const phoneRegex = /^(\+27|0)[0-9]{9}$/;
            if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
                alert('Please enter a valid South African phone number (e.g., +27 82 123 4567 or 082 123 4567)');
                return;
            }
            
            // Validate budget range
            if (budgetMax > 0 && budgetMin > budgetMax) {
                alert('Budget minimum cannot be greater than budget maximum');
                return;
            }
            
            const clientData = {
                name: name,
                phone: phone,
                email: email,
                type: formData.get('type'),
                birthday: formData.get('birthday'),
                budgetMin: budgetMin,
                budgetMax: budgetMax,
                reminderDate: formData.get('reminderDate'),
                notes: formData.get('notes')
            };
            
            try {
                const result = await apiRequest('clients', {
                    method: 'POST',
                    body: JSON.stringify(clientData)
                });
                
                // Add to local array
                clients.push(result.client);
                saveDataToStorage(); // Keep backup
                
            renderClients();
            populateClientOptions();
            closeModal('addClientModal');
            event.target.reset();
                alert('Client added successfully!');
                
            } catch (error) {
                console.error('Failed to add client:', error);
                // Handle specific API errors
                if (error.message.includes('already exists')) {
                    alert('A client with this email address already exists!');
                } else {
                    alert('Failed to add client. Please try again.');
                }
            }
        }

        function renderClients() {
            const tbody = document.querySelector('#clientsTable tbody');
            tbody.innerHTML = '';
            
            const filteredClients = getFilteredClients();
            
            filteredClients.forEach(client => {
                const row = document.createElement('tr');
                
                // Calculate days until birthday
                let birthdayInfo = '';
                if (client.birthday) {
                    const today = new Date();
                    const birthday = new Date(client.birthday);
                    birthday.setFullYear(today.getFullYear());
                    
                    if (birthday < today) {
                        birthday.setFullYear(today.getFullYear() + 1);
                    }
                    
                    const diffTime = birthday - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 7) {
                        birthdayInfo = `<span class="birthday-badge">Birthday in ${diffDays} days!</span>`;
                    }
                }

                row.innerHTML = `
                    <td>
                        <span class="clickable-name" onclick="showClientDetails(${client.id})">${client.name}</span>
                    </td>
                    <td><span class="property-status status-${client.type}">${client.type}</span></td>
                    <td>${formatCurrency(client.budgetMin)} - ${formatCurrency(client.budgetMax)}</td>
                    <td>${formatDate(client.birthday)} ${birthdayInfo}</td>
                    <td>
                        ${client.reminderDate ? formatDate(client.reminderDate) : 'No reminder set'}
                        ${client.reminderDate && new Date(client.reminderDate) <= new Date() ? '<span class="reminder-badge">Due!</span>' : ''}
                    </td>
                    <td class="contact-actions">
                        <button class="btn btn-info btn-small" onclick="callClient('${client.phone}')">üìû Call</button>
                        <button class="btn btn-success btn-small" onclick="emailClient('${client.email}')">üìß Email</button>
                        <button class="btn btn-warning btn-small" onclick="editClient(${client.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteClient(${client.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getFilteredClients() {
            let filtered = [...clients];
            
            const nameFilter = document.getElementById('nameFilter')?.value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter')?.value;
            const minPrice = parseInt(document.getElementById('minPrice')?.value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice')?.value) || Infinity;
            
            if (nameFilter) {
                filtered = filtered.filter(client => 
                    client.name.toLowerCase().includes(nameFilter) ||
                    client.email.toLowerCase().includes(nameFilter) ||
                    client.phone.toLowerCase().includes(nameFilter) ||
                    (client.notes && client.notes.toLowerCase().includes(nameFilter))
                );
            }
            
            if (typeFilter) {
                filtered = filtered.filter(client => client.type === typeFilter);
            }
            
            if (minPrice > 0 || maxPrice < Infinity) {
                filtered = filtered.filter(client => {
                    const clientMin = client.budgetMin || 0;
                    const clientMax = client.budgetMax || Infinity;
                    return (clientMax >= minPrice && clientMin <= maxPrice);
                });
            }
            
            return filtered;
        }

        function filterClients() {
            renderClients();
        }

        function showClientDetails(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const detailsDiv = document.getElementById('clientDetailsDisplay');
            detailsDiv.innerHTML = `
                <div class="client-detail-card">
                    <h3>${client.name}</h3>
                    <div class="client-detail-grid">
                        <div class="detail-item">
                            <strong>Contact Details</strong>
                            <div>üìû ${client.phone}</div>
                            <div>üìß ${client.email}</div>
                        </div>
                        <div class="detail-item">
                            <strong>Client Type</strong>
                            <div>${client.type.charAt(0).toUpperCase() + client.type.slice(1)}</div>
                        </div>
                        <div class="detail-item">
                            <strong>Budget Range</strong>
                            <div>${formatCurrency(client.budgetMin)} - ${formatCurrency(client.budgetMax)}</div>
                        </div>
                        <div class="detail-item">
                            <strong>Birthday</strong>
                            <div>${formatDate(client.birthday)}</div>
                        </div>
                    </div>
                    ${client.notes ? `<div style="margin-top: 15px;"><strong>Notes:</strong><br>${client.notes}</div>` : ''}
                    <div style="margin-top: 15px;">
                        <button class="btn btn-warning" onclick="hideClientDetails()">‚Üê Back to List</button>
                    </div>
                </div>
            `;
            detailsDiv.style.display = 'block';
        }

        function hideClientDetails() {
            document.getElementById('clientDetailsDisplay').style.display = 'none';
        }

        function callClient(phone) {
            window.open(`tel:${phone}`, '_self');
        }

        function emailClient(email) {
            window.open(`mailto:${email}`, '_self');
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Populate the edit form with current client data
            document.getElementById('editClientId').value = client.id;
            document.getElementById('editClientName').value = client.name;
            document.getElementById('editClientPhone').value = client.phone;
            document.getElementById('editClientEmail').value = client.email;
            document.getElementById('editClientType').value = client.type;
            document.getElementById('editClientBirthday').value = client.birthday;
            document.getElementById('editClientReminderDate').value = client.reminderDate;
            document.getElementById('editClientBudgetMin').value = client.budgetMin;
            document.getElementById('editClientBudgetMax').value = client.budgetMax;
            document.getElementById('editClientNotes').value = client.notes;
            
            showModal('editClientModal');
        }

        async function updateClient(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clientId = parseInt(formData.get('clientId'));
            
            const clientData = {
                id: clientId,
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                type: formData.get('type'),
                birthday: formData.get('birthday'),
                budgetMin: parseInt(formData.get('budgetMin')) || 0,
                budgetMax: parseInt(formData.get('budgetMax')) || 0,
                reminderDate: formData.get('reminderDate'),
                notes: formData.get('notes')
            };
            
            try {
                const result = await apiRequest('clients', {
                    method: 'PUT',
                    body: JSON.stringify(clientData)
                });
                
                // Update local array
                const clientIndex = clients.findIndex(c => c.id === clientId);
                if (clientIndex !== -1) {
                    clients[clientIndex] = result.client;
                    saveDataToStorage(); // Keep backup
                }
                
                renderClients();
                populateClientOptions();
                closeModal('editClientModal');
                alert('Client updated successfully!');
                
            } catch (error) {
                console.error('Failed to update client:', error);
                alert('Failed to update client. Please try again.');
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client?')) {
                return;
            }
            
            try {
                await apiRequest('clients', {
                    method: 'DELETE',
                    body: JSON.stringify({ id: clientId })
                });
                
                // Remove from local array
                clients = clients.filter(c => c.id !== clientId);
                saveDataToStorage(); // Keep backup
                
                renderClients();
                populateClientOptions();
                alert('Client deleted successfully!');
                
            } catch (error) {
                console.error('Failed to delete client:', error);
                alert('Failed to delete client. Please try again.');
            }
        }

        // Lead functions
        async function addLead(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const leadData = {
                name: formData.get('leadName'),
                phone: formData.get('leadPhone'),
                email: formData.get('leadEmail'),
                interest: formData.get('leadInterest'),
                followUpDate: formData.get('followUpDate'),
                status: formData.get('leadStatus'),
                notes: formData.get('leadNotes')
            };
            
            try {
                const result = await apiRequest('leads', {
                    method: 'POST',
                    body: JSON.stringify(leadData)
                });
                
                leads.push(result.lead);
                saveDataToStorage();
            renderLeads();
            closeModal('addLeadModal');
            event.target.reset();
                alert('Lead added successfully!');
                
            } catch (error) {
                console.error('Failed to add lead:', error);
                alert('Failed to add lead. Please try again.');
            }
        }

        function renderLeads() {
            const tbody = document.querySelector('#leadsTable tbody');
            tbody.innerHTML = '';
            
            const filteredLeads = getFilteredLeads();
            
            filteredLeads.forEach(lead => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lead.name}</td>
                    <td>
                        üìû ${lead.phone}<br>
                        ${lead.email ? `üìß ${lead.email}` : ''}
                    </td>
                    <td>${lead.interest}</td>
                    <td>
                        ${formatDate(lead.followUpDate)}
                        ${new Date(lead.followUpDate) <= new Date() ? '<span class="reminder-badge">Due!</span>' : ''}
                    </td>
                    <td><span class="property-status status-${lead.status.replace('-', '')}">${lead.status}</span></td>
                    <td class="contact-actions">
                        <button class="btn btn-info btn-small" onclick="callClient('${lead.phone}')">üìû Call</button>
                        ${lead.email ? `<button class="btn btn-success btn-small" onclick="emailClient('${lead.email}')">üìß Email</button>` : ''}
                        <button class="btn btn-warning btn-small" onclick="editLead(${lead.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-warning btn-small" onclick="convertToClient(${lead.id})">‚ú® Convert</button>
                        <button class="btn btn-danger btn-small" onclick="deleteLead(${lead.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getFilteredLeads() {
            let filtered = [...leads];
            
            const nameFilter = document.getElementById('leadNameFilter')?.value.toLowerCase();
            const dateFilter = document.getElementById('leadDateFilter')?.value;
            
            if (nameFilter) {
                filtered = filtered.filter(lead => 
                    lead.name.toLowerCase().includes(nameFilter) ||
                    (lead.email && lead.email.toLowerCase().includes(nameFilter)) ||
                    lead.phone.toLowerCase().includes(nameFilter) ||
                    lead.interest.toLowerCase().includes(nameFilter) ||
                    (lead.notes && lead.notes.toLowerCase().includes(nameFilter))
                );
            }
            
            if (dateFilter) {
                filtered = filtered.filter(lead => lead.followUpDate === dateFilter);
            }
            
            return filtered;
        }

        function filterLeads() {
            renderLeads();
        }

        function convertToClient(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            
            if (confirm(`Convert ${lead.name} to a client?`)) {
                const client = {
                    id: Date.now(),
                    name: lead.name,
                    phone: lead.phone,
                    email: lead.email || '',
                    type: lead.interest === 'buying' ? 'buyer' : lead.interest === 'selling' ? 'seller' : 'tenant',
                    birthday: '',
                    budgetMin: 0,
                    budgetMax: 0,
                    reminderDate: '',
                    notes: `Converted from lead. Original notes: ${lead.notes}`
                };
                
                clients.push(client);
                leads = leads.filter(l => l.id !== leadId);
                saveDataToStorage();
                
                renderClients();
                renderLeads();
                populateClientOptions();
                
                alert(`${lead.name} has been converted to a client!`);
            }
        }

        function editLead(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            
            // Populate the edit form with current lead data
            document.getElementById('editLeadId').value = lead.id;
            document.getElementById('editLeadName').value = lead.name;
            document.getElementById('editLeadPhone').value = lead.phone;
            document.getElementById('editLeadEmail').value = lead.email;
            document.getElementById('editLeadInterest').value = lead.interest;
            document.getElementById('editLeadFollowUpDate').value = lead.followUpDate;
            document.getElementById('editLeadStatus').value = lead.status;
            document.getElementById('editLeadNotes').value = lead.notes;
            
            showModal('editLeadModal');
        }

        async function updateLead(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const leadId = parseInt(formData.get('leadId'));
            
            const leadData = {
                id: leadId,
                name: formData.get('leadName'),
                phone: formData.get('leadPhone'),
                email: formData.get('leadEmail'),
                interest: formData.get('leadInterest'),
                followUpDate: formData.get('followUpDate'),
                status: formData.get('leadStatus'),
                notes: formData.get('leadNotes')
            };
            
            try {
                const result = await apiRequest('leads', {
                    method: 'PUT',
                    body: JSON.stringify(leadData)
                });
                
                const leadIndex = leads.findIndex(l => l.id === leadId);
                if (leadIndex !== -1) {
                    leads[leadIndex] = result.lead;
                    saveDataToStorage();
                }
                
                renderLeads();
                closeModal('editLeadModal');
                alert('Lead updated successfully!');
                
            } catch (error) {
                console.error('Failed to update lead:', error);
                alert('Failed to update lead. Please try again.');
            }
        }

        async function deleteLead(leadId) {
            if (!confirm('Are you sure you want to delete this lead?')) {
                return;
            }
            
            try {
                await apiRequest('leads', {
                    method: 'DELETE',
                    body: JSON.stringify({ id: leadId })
                });
                
                leads = leads.filter(l => l.id !== leadId);
                saveDataToStorage();
                renderLeads();
                alert('Lead deleted successfully!');
                
            } catch (error) {
                console.error('Failed to delete lead:', error);
                alert('Failed to delete lead. Please try again.');
            }
        }

        // Property functions
        async function addProperty(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const propertyData = {
                title: formData.get('title'),
                price: parseInt(formData.get('price')),
                type: formData.get('propertyType'),
                status: formData.get('status'),
                bedrooms: parseInt(formData.get('bedrooms')) || 0,
                bathrooms: parseFloat(formData.get('bathrooms')) || 0,
                size: parseInt(formData.get('size')) || 0,
                location: formData.get('location'),
                description: formData.get('description')
            };
            
            try {
                const result = await apiRequest('properties', {
                    method: 'POST',
                    body: JSON.stringify(propertyData)
                });
                
                properties.push(result.property);
                saveDataToStorage();
            renderProperties();
            closeModal('addPropertyModal');
            event.target.reset();
                alert('Property added successfully!');
                
            } catch (error) {
                console.error('Failed to add property:', error);
                alert('Failed to add property. Please try again.');
            }
        }

        function renderProperties() {
            const container = document.getElementById('propertiesList');
            container.innerHTML = '';
            
            const filteredProperties = getFilteredProperties();
            
            filteredProperties.forEach(property => {
                const card = document.createElement('div');
                card.className = 'property-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <h3 style="margin: 0; color: #333;">${property.title}</h3>
                            <p style="margin: 5px 0; color: #666;">üìç ${property.location}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="property-status status-${property.status}">${property.status}</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div>
                            <strong>Price:</strong><br>
                            ${formatCurrency(property.price)}
                        </div>
                        <div>
                            <strong>Type:</strong><br>
                            For ${property.type === 'sale' ? 'Sale' : 'Rent'}
                        </div>
                        <div>
                            <strong>Size:</strong><br>
                            ${property.size} m¬≤
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div>
                            <strong>Bedrooms:</strong> ${property.bedrooms}
                        </div>
                        <div>
                            <strong>Bathrooms:</strong> ${property.bathrooms}
                        </div>
                    </div>
                    
                    ${property.description ? `<div style="margin: 15px 0;"><strong>Description:</strong><br>${property.description}</div>` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-info btn-small" onclick="shareProperty(${property.id})">üì§ Share</button>
                        <button class="btn btn-warning btn-small" onclick="editProperty(${property.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteProperty(${property.id})">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function getFilteredProperties() {
            let filtered = [...properties];
            
            const statusFilter = document.getElementById('statusFilter')?.value;
            const typeFilter = document.getElementById('propertyTypeFilter')?.value;
            const minPrice = parseInt(document.getElementById('propMinPrice')?.value) || 0;
            const maxPrice = parseInt(document.getElementById('propMaxPrice')?.value) || Infinity;
            
            // Add a text search for properties
            const searchTerm = document.getElementById('propertySearch')?.value?.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(property => 
                    property.title.toLowerCase().includes(searchTerm) ||
                    property.location.toLowerCase().includes(searchTerm) ||
                    (property.description && property.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(property => property.status === statusFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(property => property.type === typeFilter);
            }
            
            if (minPrice > 0 || maxPrice < Infinity) {
                filtered = filtered.filter(property => 
                    property.price >= minPrice && property.price <= maxPrice
                );
            }
            
            return filtered;
        }

        function filterProperties() {
            renderProperties();
        }

        function shareProperty(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return;
            
            const message = `üè† ${property.title}\nüìç ${property.location}\nüí∞ ${formatCurrency(property.price)}\nüõèÔ∏è ${property.bedrooms} bedrooms, üõÅ ${property.bathrooms} bathrooms\nüìê ${property.size} m¬≤\n\n${property.description}`;
            
            if (navigator.share) {
                navigator.share({
                    title: property.title,
                    text: message
                });
            } else {
                navigator.clipboard.writeText(message).then(() => {
                    alert('Property details copied to clipboard!');
                });
            }
        }

        function editProperty(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return;
            
            // Populate the edit form with current property data
            document.getElementById('editPropertyId').value = property.id;
            document.getElementById('editPropertyTitle').value = property.title;
            document.getElementById('editPropertyPrice').value = property.price;
            document.getElementById('editPropertyType').value = property.type;
            document.getElementById('editPropertyStatus').value = property.status;
            document.getElementById('editPropertyBedrooms').value = property.bedrooms;
            document.getElementById('editPropertyBathrooms').value = property.bathrooms;
            document.getElementById('editPropertySize').value = property.size;
            document.getElementById('editPropertyLocation').value = property.location;
            document.getElementById('editPropertyDescription').value = property.description;
            
            showModal('editPropertyModal');
        }

        async function updateProperty(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const propertyId = parseInt(formData.get('propertyId'));
            
            const propertyData = {
                id: propertyId,
                title: formData.get('title'),
                price: parseInt(formData.get('price')),
                type: formData.get('propertyType'),
                status: formData.get('status'),
                bedrooms: parseInt(formData.get('bedrooms')) || 0,
                bathrooms: parseFloat(formData.get('bathrooms')) || 0,
                size: parseInt(formData.get('size')) || 0,
                location: formData.get('location'),
                description: formData.get('description')
            };
            
            try {
                const result = await apiRequest('properties', {
                    method: 'PUT',
                    body: JSON.stringify(propertyData)
                });
                
                const propertyIndex = properties.findIndex(p => p.id === propertyId);
                if (propertyIndex !== -1) {
                    properties[propertyIndex] = result.property;
                    saveDataToStorage();
                }
                
                renderProperties();
                closeModal('editPropertyModal');
                alert('Property updated successfully!');
                
            } catch (error) {
                console.error('Failed to update property:', error);
                alert('Failed to update property. Please try again.');
            }
        }

        async function deleteProperty(propertyId) {
            if (!confirm('Are you sure you want to delete this property?')) {
                return;
            }
            
            try {
                await apiRequest('properties', {
                    method: 'DELETE',
                    body: JSON.stringify({ id: propertyId })
                });
                
                properties = properties.filter(p => p.id !== propertyId);
                saveDataToStorage();
                renderProperties();
                alert('Property deleted successfully!');
                
            } catch (error) {
                console.error('Failed to delete property:', error);
                alert('Failed to delete property. Please try again.');
            }
        }

        // Reminder functions
        async function addReminder(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const reminderData = {
                title: formData.get('reminderTitle'),
                date: formData.get('reminderDate'),
                time: formData.get('reminderTime'),
                type: formData.get('reminderType'),
                relatedClient: formData.get('relatedClient'),
                notes: formData.get('reminderNotes')
            };
            
            try {
                const result = await apiRequest('reminders', {
                    method: 'POST',
                    body: JSON.stringify(reminderData)
                });
                
                reminders.push(result.reminder);
                saveDataToStorage();
            renderReminders();
            closeModal('addReminderModal');
            event.target.reset();
                alert('Reminder added successfully!');
                
            } catch (error) {
                console.error('Failed to add reminder:', error);
                alert('Failed to add reminder. Please try again.');
            }
        }

        function renderReminders() {
            const container = document.getElementById('remindersList');
            container.innerHTML = '';
            
            const filteredReminders = getFilteredReminders();
            const today = new Date().toISOString().split('T')[0];
            
            // Sort by date
            filteredReminders.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            filteredReminders.forEach(reminder => {
                const card = document.createElement('div');
                card.className = 'property-card';
                
                const isOverdue = reminder.date < today;
                const isToday = reminder.date === today;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0; color: #333;">${reminder.title}</h4>
                            <p style="margin: 5px 0;">
                                üìÖ ${formatDate(reminder.date)} 
                                ${reminder.time ? `üïê ${reminder.time}` : ''}
                                ${isOverdue ? '<span class="reminder-badge">Overdue!</span>' : ''}
                                ${isToday ? '<span class="birthday-badge">Today!</span>' : ''}
                            </p>
                            <p style="margin: 5px 0;">
                                üè∑Ô∏è <span class="property-status status-${reminder.type.replace('-', '')}">${reminder.type}</span>
                                ${reminder.relatedClient ? ` | üë§ ${reminder.relatedClient}` : ''}
                            </p>
                            ${reminder.notes ? `<p style="margin: 10px 0; color: #666;">${reminder.notes}</p>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-success btn-small" onclick="completeReminder(${reminder.id})">‚úÖ Complete</button>
                            <button class="btn btn-danger btn-small" onclick="deleteReminder(${reminder.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function getFilteredReminders() {
            let filtered = [...reminders];
            
            const dateFilter = document.getElementById('reminderDateFilter')?.value;
            const typeFilter = document.getElementById('reminderTypeFilter')?.value;
            
            if (dateFilter) {
                filtered = filtered.filter(reminder => reminder.date === dateFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(reminder => reminder.type === typeFilter);
            }
            
            return filtered;
        }

        function filterReminders() {
            renderReminders();
        }

        async function completeReminder(reminderId) {
            if (!confirm('Mark this reminder as complete?')) {
                return;
            }
            
            try {
                await apiRequest('reminders', {
                    method: 'DELETE',
                    body: JSON.stringify({ id: reminderId })
                });
                
                reminders = reminders.filter(r => r.id !== reminderId);
                saveDataToStorage();
                renderReminders();
                alert('Reminder marked as complete!');
                
            } catch (error) {
                console.error('Failed to complete reminder:', error);
                alert('Failed to complete reminder. Please try again.');
            }
        }

        async function deleteReminder(reminderId) {
            if (!confirm('Are you sure you want to delete this reminder?')) {
                return;
            }
            
            try {
                await apiRequest('reminders', {
                    method: 'DELETE',
                    body: JSON.stringify({ id: reminderId })
                });
                
                reminders = reminders.filter(r => r.id !== reminderId);
                saveDataToStorage();
                renderReminders();
                alert('Reminder deleted successfully!');
                
            } catch (error) {
                console.error('Failed to delete reminder:', error);
                alert('Failed to delete reminder. Please try again.');
            }
        }

        // Comment functions
        async function addComment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const commentData = {
                title: formData.get('commentTitle'),
                category: formData.get('commentCategory'),
                relatedTo: formData.get('relatedTo'),
                content: formData.get('commentContent'),
                date: new Date().toISOString().split('T')[0]
            };
            
            try {
                const result = await apiRequest('comments', {
                    method: 'POST',
                    body: JSON.stringify(commentData)
                });
                
                comments.push(result.comment);
                saveDataToStorage();
            renderComments();
            closeModal('addCommentModal');
            event.target.reset();
                alert('Note added successfully!');
                
            } catch (error) {
                console.error('Failed to add note:', error);
                alert('Failed to add note. Please try again.');
            }
        }

        function renderComments() {
            const container = document.getElementById('commentsList');
            container.innerHTML = '';
            
            const filteredComments = getFilteredComments();
            
            // Sort by date (newest first)
            filteredComments.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredComments.forEach(comment => {
                const card = document.createElement('div');
                card.className = 'property-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <h4 style="margin: 0; color: #333;">${comment.title}</h4>
                            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                                üìÖ ${formatDate(comment.date)} | 
                                üè∑Ô∏è <span class="property-status status-${comment.category}">${comment.category}</span>
                                ${comment.relatedTo ? ` | üîó ${comment.relatedTo}` : ''}
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-danger btn-small" onclick="deleteComment(${comment.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 3px solid #667eea;">
                        ${comment.content.replace(/\n/g, '<br>')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function getFilteredComments() {
            let filtered = [...comments];
            
            const categoryFilter = document.getElementById('commentCategoryFilter')?.value;
            
            if (categoryFilter) {
                filtered = filtered.filter(comment => comment.category === categoryFilter);
            }
            
            return filtered;
        }

        function filterComments() {
            renderComments();
        }

        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            try {
                await apiRequest('comments', {
                    method: 'DELETE',
                    body: JSON.stringify({ id: commentId })
                });
                
                comments = comments.filter(c => c.id !== commentId);
                saveDataToStorage();
                renderComments();
                alert('Note deleted successfully!');
                
            } catch (error) {
                console.error('Failed to delete note:', error);
                alert('Failed to delete note. Please try again.');
            }
        }

        // Import functionality
        function importListing() {
            const url = document.getElementById('listingUrl').value.trim();
            
            // Validate URL
            if (!url) {
                alert('Please enter a URL to import');
                return;
            }
            
            // Basic URL validation
            try {
                new URL(url);
            } catch (e) {
                alert('Please enter a valid URL (e.g., https://property24.com/...)');
                return;
            }
            
            // Check if URL is from supported sites
            const supportedSites = ['property24.com', 'privateproperty.co.za', 'realnet.co.za'];
            const isSupported = supportedSites.some(site => url.toLowerCase().includes(site));
            
            if (!isSupported) {
                const proceed = confirm(`This URL doesn't appear to be from a supported property site (${supportedSites.join(', ')}). Continue anyway?`);
                if (!proceed) return;
            }
            
            // Simulate import process
            const importResult = document.getElementById('importResult');
            const importedDetails = document.getElementById('importedDetails');
            
            // Show loading
            importedDetails.innerHTML = '‚è≥ Importing listing data...';
            importResult.style.display = 'block';
            
            // Simulate delay and then show mock imported data
            setTimeout(() => {
                // Simulate different outcomes based on URL
                const random = Math.random();
                
                if (random < 0.1) {
                    // Simulate import failure
                    importedDetails.innerHTML = `
                        <div style="padding: 15px; background: #f8d7da; border-radius: 5px; color: #721c24;">
                            ‚ùå Failed to import listing data. This could be due to:<br>
                            ‚Ä¢ The listing page has changed format<br>
                            ‚Ä¢ Network connectivity issues<br>
                            ‚Ä¢ The listing may have been removed<br><br>
                            Please try again or enter property details manually.
                        </div>
                    `;
                } else {
                    // Successful import with mock data
                importedDetails.innerHTML = `
                    <h4>üìç Luxury 4BR Home in Constantia</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div><strong>Price:</strong> R3,250,000</div>
                        <div><strong>Type:</strong> For Sale</div>
                        <div><strong>Bedrooms:</strong> 4</div>
                        <div><strong>Bathrooms:</strong> 3</div>
                        <div><strong>Size:</strong> 320 m¬≤</div>
                        <div><strong>Location:</strong> Constantia, Cape Town</div>
                    </div>
                    <div><strong>Description:</strong><br>
                    Magnificent family home situated in the heart of Constantia. Features include modern kitchen, spacious living areas, swimming pool, and double garage. Close to top schools and shopping centers.
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                            ‚úÖ Data successfully imported from ${new URL(url).hostname}
                    </div>
                `;
                }
            }, 2000);
        }

        async function saveImportedProperty() {
            // This would normally extract the imported data and save it
            const propertyData = {
                title: "Luxury 4BR Home in Constantia",
                price: 3250000,
                type: "sale",
                status: "active",
                bedrooms: 4,
                bathrooms: 3,
                size: 320,
                location: "Constantia, Cape Town",
                description: "Magnificent family home situated in the heart of Constantia. Features include modern kitchen, spacious living areas, swimming pool, and double garage. Close to top schools and shopping centers."
            };
            
            try {
                const result = await apiRequest('properties', {
                    method: 'POST',
                    body: JSON.stringify(propertyData)
                });
                
                properties.push(result.property);
                saveDataToStorage();
            renderProperties();
            
            // Hide import result and show success
            document.getElementById('importResult').style.display = 'none';
            document.getElementById('listingUrl').value = '';
            
                alert('‚úÖ Property successfully imported and saved to database!');
            
            // Switch to properties tab
            showTab('properties');
            document.querySelector('button[onclick="showTab(\'properties\')"]').classList.add('active');
                
            } catch (error) {
                console.error('Failed to save imported property:', error);
                alert('Failed to save imported property to database. Please try again.');
            }
        }

        // Chat functionality
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.style.cssText = 'padding: 10px; background: #667eea; color: white; border-radius: 8px; margin-bottom: 10px; margin-left: 20%; text-align: right;';
            userMessage.innerHTML = `<strong>You:</strong> ${message}`;
            messages.appendChild(userMessage);
            
            input.value = '';
            
            // Simulate AI response
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                const aiMessage = document.createElement('div');
                aiMessage.style.cssText = 'padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px; margin-right: 20%;';
                aiMessage.innerHTML = `<strong>AI Assistant:</strong> ${aiResponse}`;
                messages.appendChild(aiMessage);
                messages.scrollTop = messages.scrollHeight;
            }, 1000);
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('email') || message.includes('message')) {
                return `I'd be happy to help you create a professional email or message! Here's a template:<br><br>
                <strong>Subject:</strong> Property Inquiry - [Property Address]<br><br>
                <strong>Dear [Client Name],</strong><br><br>
                Thank you for your interest in [property details]. I wanted to follow up on our previous conversation and provide you with some additional information...<br><br>
                Would you like me to customize this for a specific situation?`;
            } else if (message.includes('follow up') || message.includes('followup')) {
                return `Here's a professional follow-up message template:<br><br>
                <strong>Hi [Client Name],</strong><br><br>
                I hope this message finds you well. I wanted to touch base regarding your property search for [area/requirements]. Since our last conversation, I have [new listings/updates] that might interest you...<br><br>
                Would you be available for a quick call this week to discuss?`;
            } else if (message.includes('birthday') || message.includes('greeting')) {
                return `Here's a warm birthday greeting for your clients:<br><br>
                <strong>Happy Birthday [Client Name]! üéâ</strong><br><br>
                Wishing you a wonderful year ahead filled with happiness and success. Thank you for trusting us with your real estate needs. Looking forward to helping you find your dream home this year!<br><br>
                Best wishes,<br>
                Seyn & Kanya`;
            } else {
                return `I'm here to help you with professional real estate communications! I can assist with:<br>
                ‚Ä¢ Email templates for clients<br>
                ‚Ä¢ Follow-up messages<br>
                ‚Ä¢ Birthday greetings<br>
                ‚Ä¢ Property descriptions<br>
                ‚Ä¢ Meeting confirmations<br><br>
                What type of message would you like help creating?`;
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Populate client options for reminders
        function populateClientOptions() {
            const select = document.querySelector('select[name="relatedClient"]');
            if (!select) return;
            
            // Keep the default option
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            select.appendChild(defaultOption);
            
            // Add client options
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }

        // Export data functionality
        function exportData() {
            const choice = confirm('Export as JSON? Click OK for JSON, Cancel for CSV');
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (choice) {
                // Export as JSON
                const data = {
                    exportDate: new Date().toISOString(),
                    clients: clients,
                    leads: leads,
                    properties: properties,
                    reminders: reminders,
                    comments: comments
                };
                
                downloadFile(
                    JSON.stringify(data, null, 2),
                    `crm-data-${timestamp}.json`,
                    'application/json'
                );
            } else {
                // Export as CSV (clients only for simplicity)
                let csv = 'Type,Name,Email,Phone,Client Type,Budget Min,Budget Max,Notes\n';
                
                clients.forEach(client => {
                    csv += `Client,"${client.name}","${client.email}","${client.phone}","${client.type}",${client.budgetMin},${client.budgetMax},"${client.notes || ''}"\n`;
                });
                
                leads.forEach(lead => {
                    csv += `Lead,"${lead.name}","${lead.email || ''}","${lead.phone}","${lead.interest}",,,,"${lead.notes || ''}"\n`;
                });
                
                downloadFile(csv, `crm-contacts-${timestamp}.csv`, 'text/csv');
            }
        }

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Notification functionality
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                        checkForUpcomingReminders();
                    }
                });
            }
        }

        function checkForUpcomingReminders() {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }

            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            
            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            // Check reminders
            const upcomingReminders = reminders.filter(reminder => 
                reminder.date === todayStr || reminder.date === tomorrowStr
            );

            // Check client birthdays
            const upcomingBirthdays = clients.filter(client => {
                if (!client.birthday) return false;
                const birthday = new Date(client.birthday);
                birthday.setFullYear(today.getFullYear());
                
                const birthdayStr = birthday.toISOString().split('T')[0];
                return birthdayStr === todayStr || birthdayStr === tomorrowStr;
            });

            // Show notifications
            upcomingReminders.forEach(reminder => {
                const when = reminder.date === todayStr ? 'today' : 'tomorrow';
                new Notification(`Reminder ${when}: ${reminder.title}`, {
                    body: reminder.notes || 'Click to view details',
                    icon: 'üìÖ'
                });
            });

            upcomingBirthdays.forEach(client => {
                const when = todayStr === new Date(client.birthday).toISOString().split('T')[0] ? 'today' : 'tomorrow';
                new Notification(`Birthday ${when}: ${client.name}`, {
                    body: 'Don\'t forget to wish them a happy birthday!',
                    icon: 'üéÇ'
                });
            });
        }

        // PWA Installation functionality
        let deferredPrompt;
        let installButton;

        function initializePWA() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available, show update prompt
                                    showUpdatePrompt();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            }

            // Handle PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });

            // Handle app installed
            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                hideInstallButton();
                showInstalledMessage();
            });
        }

        function showInstallButton() {
            // Create install button if it doesn't exist
            if (!installButton) {
                installButton = document.createElement('button');
                installButton.className = 'btn btn-primary btn-small';
                installButton.innerHTML = 'üì± Install App';
                installButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                `;
                installButton.onclick = installPWA;
                document.body.appendChild(installButton);
            }
        }

        function hideInstallButton() {
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        }

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Install prompt outcome:', outcome);
                deferredPrompt = null;
                hideInstallButton();
            }
        }

        function showUpdatePrompt() {
            const updateAvailable = confirm(
                'A new version of the app is available. Would you like to update now?'
            );
            
            if (updateAvailable) {
                window.location.reload();
            }
        }

        function showInstalledMessage() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            `;
            message.innerHTML = '‚úÖ App installed successfully!';
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        // Handle URL shortcuts
        function handleShortcuts() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'add-client') {
                showModal('addClientModal');
            } else if (action === 'add-property') {
                showModal('addPropertyModal');
            }
        }

        // Floating Action Button Functions
        function showQuickAdd() {
            const menu = document.getElementById('quickAddMenu');
            const fab = document.querySelector('.fab');
            
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
                menu.style.animation = 'slideIn 0.3s ease-out';
                fab.innerHTML = '‚úï';
                fab.style.transform = 'rotate(45deg)';
            } else {
                menu.style.display = 'none';
                fab.innerHTML = '‚ûï';
                fab.style.transform = 'rotate(0deg)';
            }
        }

        function quickAddClient() {
            hideQuickAdd();
            showTab('contacts');
            setTimeout(() => showModal('addClientModal'), 100);
        }

        function quickAddLead() {
            hideQuickAdd();
            showTab('leads');
            setTimeout(() => showModal('addLeadModal'), 100);
        }

        function quickAddProperty() {
            hideQuickAdd();
            showTab('properties');
            setTimeout(() => showModal('addPropertyModal'), 100);
        }

        function quickAddReminder() {
            hideQuickAdd();
            showTab('reminders');
            setTimeout(() => showModal('addReminderModal'), 100);
        }

        function hideQuickAdd() {
            const menu = document.getElementById('quickAddMenu');
            const fab = document.querySelector('.fab');
            menu.style.display = 'none';
            fab.innerHTML = '‚ûï';
            fab.style.transform = 'rotate(0deg)';
        }

        // Close quick add menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('quickAddMenu');
            const fab = document.querySelector('.fab');
            
            if (!menu.contains(event.target) && !fab.contains(event.target)) {
                hideQuickAdd();
            }
        });

        // Enhanced Loading States
        function showLoadingIndicator(container) {
            if (typeof container === 'string') {
                container = document.getElementById(container);
            }
            if (container) {
                container.innerHTML = `
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        Loading data...
                    </div>
                `;
            }
        }

        function hideLoadingIndicator() {
            // This will be hidden when actual content is loaded
        }

        // Enhanced Error Handling
        function showError(message, container) {
            if (typeof container === 'string') {
                container = document.getElementById(container);
            }
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <h3>Oops! Something went wrong</h3>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Empty State Helper
        function showEmptyState(container, icon, title, message, actionText, actionCallback) {
            if (typeof container === 'string') {
                container = document.getElementById(container);
            }
            if (container) {
                const actionButton = actionCallback ? 
                    `<button class="btn btn-primary" onclick="${actionCallback}">${actionText}</button>` : '';
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">${icon}</div>
                        <h3>${title}</h3>
                        <p>${message}</p>
                        ${actionButton}
                    </div>
                `;
            }
        }

        // Enhanced Filter Functions
        function clearFilters(type) {
            switch(type) {
                case 'clients':
                    document.getElementById('nameFilter').value = '';
                    document.getElementById('typeFilter').value = '';
                    document.getElementById('minPrice').value = '';
                    document.getElementById('maxPrice').value = '';
                    filterClients();
                    break;
                case 'leads':
                    document.getElementById('leadNameFilter').value = '';
                    document.getElementById('leadStatusFilter').value = '';
                    filterLeads();
                    break;
                case 'properties':
                    document.getElementById('propertySearchFilter').value = '';
                    document.getElementById('propertyTypeFilter').value = '';
                    document.getElementById('propertyStatusFilter').value = '';
                    filterProperties();
                    break;
            }
        }

        function exportFilteredClients() {
            const filteredClients = getFilteredClients();
            if (filteredClients.length === 0) {
                alert('No clients match the current filters.');
                return;
            }
            
            const csvContent = [
                ['Name', 'Email', 'Phone', 'Type', 'Budget Min', 'Budget Max', 'Birthday', 'Notes'].join(','),
                ...filteredClients.map(client => [
                    client.name,
                    client.email,
                    client.phone,
                    client.type,
                    client.budgetMin || '',
                    client.budgetMax || '',
                    client.birthday || '',
                    (client.notes || '').replace(/,/g, ';')
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'filtered-clients.csv', 'text/csv');
        }

        // Enhanced search with debouncing
        let searchTimeout;
        function debounceSearch(func, delay = 300) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(func, delay);
        }

        // Add visual feedback for search results
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark style="background: rgba(26, 95, 95, 0.2); padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }

        // Enhanced table updates with smooth animations
        function updateTableWithAnimation(tableId, updateFunction) {
            const table = document.getElementById(tableId);
            if (table) {
                table.style.opacity = '0.7';
                table.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    updateFunction();
                    table.style.opacity = '1';
                    table.style.transform = 'translateY(0)';
                }, 150);
            }
        }

        // Update client statistics
        function updateClientStats() {
            const totalElement = document.getElementById('totalClients');
            const buyerElement = document.getElementById('buyerClients');
            const sellerElement = document.getElementById('sellerClients');
            const tenantElement = document.getElementById('tenantClients');
            
            if (totalElement) {
                const buyers = clients.filter(c => c.type === 'buyer').length;
                const sellers = clients.filter(c => c.type === 'seller').length;
                const tenants = clients.filter(c => c.type === 'tenant').length;
                
                // Animate number changes
                animateNumber(totalElement, clients.length);
                animateNumber(buyerElement, buyers);
                animateNumber(sellerElement, sellers);
                animateNumber(tenantElement, tenants);
            }
        }

        function animateNumber(element, targetNumber) {
            const currentNumber = parseInt(element.textContent) || 0;
            const increment = targetNumber > currentNumber ? 1 : -1;
            const duration = 500; // ms
            const steps = Math.abs(targetNumber - currentNumber);
            const stepDuration = steps > 0 ? duration / steps : 0;
            
            if (steps === 0) return;
            
            let current = currentNumber;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if (current === targetNumber) {
                    clearInterval(timer);
                }
            }, stepDuration);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            if (!checkAuthentication()) {
                return; // Will redirect to auth page
            }
            
            initializePWA();
            initializeData();
            handleShortcuts();
            
            // Request notification permission after a short delay
            setTimeout(() => {
                requestNotificationPermission();
            }, 3000);
            
            // Check for reminders every 30 minutes
            setInterval(checkForUpcomingReminders, 30 * 60 * 1000);
        });
    </script>
</body>
</html>

